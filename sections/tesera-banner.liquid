{% comment %}
  TESERA Animated Banner Section
  Add this file as sections/tesera-banner.liquid in your Shopify theme.
  Then include it in your template with {% section 'tesera-banner' %}
{% endcomment %}

{% schema %}
{
  "name": "TESERA Banner",
  "settings": [
    {
      "type": "range",
      "id": "max_width",
      "label": "Max width (px)",
      "min": 400,
      "max": 1400,
      "step": 50,
      "default": 900
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background colour",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "TESERA Banner"
    }
  ]
}
{% endschema %}

<style>
  .tesera-banner {
    background: {{ section.settings.bg_color }};
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px 20px;
  }
  .tesera-banner svg {
    width: 100%;
    max-width: {{ section.settings.max_width }}px;
  }
  .tesera-banner .tile {
    transition: fill 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
  }
  .tesera-banner .g1 { fill:#E6E6E8; }
  .tesera-banner .g2 { fill:#DADADD; }
  .tesera-banner .blue { fill:#0072CE; }
  .tesera-banner .yellow { fill:#FFC325; }
</style>

<div class="tesera-banner" id="tesera-banner-{{ section.id }}">
  <svg viewBox="0 0 852 324">
    <g id="tesera-grid-{{ section.id }}"></g>
  </svg>
</div>

<script>
(function(){
  var sectionId = "{{ section.id }}";
  var cols = 39;
  var rows = 15;
  var size = 16;
  var gap = 6;

  var grid = document.getElementById("tesera-grid-" + sectionId);

  var tileMap = {};
  for (var r = 0; r < rows; r++) {
    for (var c = 0; c < cols; c++) {
      var rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("x", c * (size + gap));
      rect.setAttribute("y", r * (size + gap));
      rect.setAttribute("width", size);
      rect.setAttribute("height", size);
      rect.setAttribute("class", "tile " + ((r + c) % 2 === 0 ? "g1":"g2"));
      grid.appendChild(rect);
      tileMap[r+","+c] = rect;
    }
  }

  function tileAt(r,c){ return tileMap[r+","+c]; }

  var font = {
    T: ["11111","00100","00100","00100","00100","00100","00100"],
    E: ["11111","10000","10000","11110","10000","10000","11111"],
    S: ["11111","10000","10000","11111","00001","00001","11111"],
    R: ["11110","10001","10001","11110","10100","10010","10001"],
    A: ["01110","10001","10001","11111","10001","10001","10001"],
  };

  var word = "TESERA";
  var letterW = 5;
  var letterH = 7;
  var gapBetween = 1;
  var totalW = word.length * letterW + (word.length - 1) * gapBetween;
  var startCol = Math.floor((cols - totalW) / 2);
  var startRow = Math.floor((rows - letterH) / 2);

  var blueTiles = [];
  for (var li = 0; li < word.length; li++) {
    var letter = font[word[li]];
    var colOff = startCol + li * (letterW + gapBetween);
    for (var dr = 0; dr < letterH; dr++) {
      for (var dc = 0; dc < letterW; dc++) {
        if (letter[dr][dc] === "1") {
          blueTiles.push([startRow + dr, colOff + dc]);
        }
      }
    }
  }

  var yellowRow = startRow;
  var yellowTiles = [];
  for (var li2 = 0; li2 < word.length; li2++) {
    var letter2 = font[word[li2]];
    var colOff2 = startCol + li2 * (letterW + gapBetween);
    var filled = [];
    for (var dc2 = 0; dc2 < letterW; dc2++) {
      if (letter2[0][dc2] === "1") filled.push(colOff2 + dc2);
    }
    yellowTiles.push([yellowRow, filled[filled.length - 2]]);
    yellowTiles.push([yellowRow, filled[filled.length - 1]]);
  }

  var yellowSet = {};
  yellowTiles.forEach(function(t){ yellowSet[t[0]+","+t[1]] = true; });
  var blueOnly = blueTiles.filter(function(t){ return !yellowSet[t[0]+","+t[1]]; });

  function groupByCol(arr) {
    var map = {};
    arr.forEach(function(t){ (map[t[1]] = map[t[1]] || []).push(t); });
    return Object.keys(map).sort(function(a,b){ return a - b; }).map(function(k){ return map[k]; });
  }

  var blueCols = groupByCol(blueOnly);
  var yellowCols = groupByCol(yellowTiles);

  var banner = document.getElementById("tesera-banner-" + sectionId);
  var animated = false;

  function runAnimation() {
    if (animated) return;
    animated = true;

    setTimeout(function(){
      blueCols.forEach(function(tiles, ci){
        setTimeout(function(){
          tiles.forEach(function(t){
            var el = tileAt(t[0],t[1]);
            if (el) el.setAttribute("class","tile blue");
          });
        }, ci * 80);
      });
    }, 600);

    var blueEnd = 600 + blueCols.length * 80;

    setTimeout(function(){
      yellowCols.forEach(function(tiles, ci){
        setTimeout(function(){
          tiles.forEach(function(t){
            var el = tileAt(t[0],t[1]);
            if (el) el.setAttribute("class","tile yellow");
          });
        }, ci * 80);
      });
    }, blueEnd + 400);
  }

  if ('IntersectionObserver' in window) {
    var observer = new IntersectionObserver(function(entries){
      entries.forEach(function(entry){
        if (entry.isIntersecting) {
          runAnimation();
          observer.disconnect();
        }
      });
    }, { threshold: 0.3 });
    observer.observe(banner);
  } else {
    runAnimation();
  }
})();
</script>
